name: Test CLI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test-cli-functionality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-manager: [npm, bun]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        if: matrix.package-manager == 'bun'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install CLI dependencies
        run: |
          cd cli
          npm install

      - name: Build CLI
        run: |
          cd cli
          npm run build

      - name: Create CLI package
        run: |
          cd cli
          npm pack

      - name: Test CLI TypeScript compilation
        run: |
          cd cli
          npx tsc --noEmit

      - name: Run CLI unit tests
        run: |
          cd cli
          npm test

      # Test NPM workflow
      - name: Test CLI with NPM - Create test project
        if: matrix.package-manager == 'npm'
        run: |
          mkdir -p test-npm-project
          cd test-npm-project
          echo '{"name": "test-project", "version": "1.0.0", "dependencies": {"react-native": "^0.70.0"}}' > package.json
          echo 'module.exports = {};' > metro.config.js
          mkdir -p android ios

      - name: Test CLI with NPM - Install CLI package
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          npm install ../cli/leshi-ui-*.tgz

      - name: Test CLI with NPM - Test init command
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          npx leshi-ui init --yes

      - name: Test CLI with NPM - Verify init created files
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          test -f leshi-ui.json || (echo "‚ùå leshi-ui.json not created" && exit 1)
          test -d styles || (echo "‚ùå styles directory not created" && exit 1)
          test -f styles/theme.ts || (echo "‚ùå theme.ts not created" && exit 1)
          test -d styles/themes || (echo "‚ùå themes directory not created" && exit 1)
          test -f styles/themes/light.ts || (echo "‚ùå light theme not created" && exit 1)
          test -f styles/themes/dark.ts || (echo "‚ùå dark theme not created" && exit 1)
          echo "‚úÖ Init command created all required files"

      - name: Test CLI with NPM - Test add simple component
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          npx leshi-ui add modal --yes

      - name: Test CLI with NPM - Verify simple component files
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          test -f src/components/ui/modal.tsx || (echo "‚ùå modal.tsx not created" && exit 1)
          test -f src/components/ui/modal-provider.tsx || (echo "‚ùå modal-provider.tsx not created" && exit 1)
          test -f lib/modal-utils.ts || (echo "‚ùå modal-utils.ts not created" && exit 1)
          echo "‚úÖ Modal component and utilities created correctly"

      - name: Test CLI with NPM - Test dependency resolution
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          npx leshi-ui add button --yes

      - name: Test CLI with NPM - Verify dependency resolution
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          test -f src/components/ui/button.tsx || (echo "‚ùå button.tsx not created" && exit 1)
          test -f src/components/ui/text.tsx || (echo "‚ùå text.tsx dependency not resolved" && exit 1)
          echo "‚úÖ Dependency resolution working correctly"

      - name: Test CLI with NPM - Test complex dependency resolution
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          npx leshi-ui add dialog --yes

      - name: Test CLI with NPM - Verify complex dependencies
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          test -f src/components/ui/dialog.tsx || (echo "‚ùå dialog.tsx not created" && exit 1)
          test -f src/components/ui/icon.tsx || (echo "‚ùå icon.tsx dependency not resolved" && exit 1)
          test -f src/components/ui/slot.tsx || (echo "‚ùå slot.tsx dependency not resolved" && exit 1)
          echo "‚úÖ Complex dependency resolution working correctly"

      - name: Test CLI with NPM - Test guide command
        if: matrix.package-manager == 'npm'
        run: |
          cd test-npm-project
          npx leshi-ui guide components | grep -q "button" || (echo "‚ùå Guide command not working" && exit 1)
          echo "‚úÖ Guide command working correctly"

      # Test BUN workflow
      - name: Test CLI with BUN - Create test project
        if: matrix.package-manager == 'bun'
        run: |
          mkdir -p test-bun-project
          cd test-bun-project
          echo '{"name": "test-bun-project", "version": "1.0.0", "dependencies": {"react-native": "^0.70.0"}}' > package.json
          echo 'module.exports = {};' > metro.config.js
          mkdir -p android ios

      - name: Test CLI with BUN - Install CLI package
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          bun install ../cli/leshi-ui-*.tgz

      - name: Test CLI with BUN - Test init command
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          bunx leshi-ui init --yes

      - name: Test CLI with BUN - Verify init created files
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          test -f leshi-ui.json || (echo "‚ùå leshi-ui.json not created" && exit 1)
          test -d styles || (echo "‚ùå styles directory not created" && exit 1)
          test -f styles/theme.ts || (echo "‚ùå theme.ts not created" && exit 1)
          test -d styles/themes || (echo "‚ùå themes directory not created" && exit 1)
          test -f styles/themes/light.ts || (echo "‚ùå light theme not created" && exit 1)
          test -f styles/themes/dark.ts || (echo "‚ùå dark theme not created" && exit 1)
          echo "‚úÖ Init command created all required files"

      - name: Test CLI with BUN - Test add simple component
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          bunx leshi-ui add modal --yes

      - name: Test CLI with BUN - Verify simple component files
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          test -f src/components/ui/modal.tsx || (echo "‚ùå modal.tsx not created" && exit 1)
          test -f src/components/ui/modal-provider.tsx || (echo "‚ùå modal-provider.tsx not created" && exit 1)
          test -f lib/modal-utils.ts || (echo "‚ùå modal-utils.ts not created" && exit 1)
          echo "‚úÖ Modal component and utilities created correctly"

      - name: Test CLI with BUN - Test dependency resolution
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          bunx leshi-ui add button --yes

      - name: Test CLI with BUN - Verify dependency resolution
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          test -f src/components/ui/button.tsx || (echo "‚ùå button.tsx not created" && exit 1)
          test -f src/components/ui/text.tsx || (echo "‚ùå text.tsx dependency not resolved" && exit 1)
          echo "‚úÖ Dependency resolution working correctly"

      - name: Test CLI with BUN - Test complex dependency resolution
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          bunx leshi-ui add dialog --yes

      - name: Test CLI with BUN - Verify complex dependencies
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          test -f src/components/ui/dialog.tsx || (echo "‚ùå dialog.tsx not created" && exit 1)
          test -f src/components/ui/icon.tsx || (echo "‚ùå icon.tsx dependency not resolved" && exit 1)
          test -f src/components/ui/slot.tsx || (echo "‚ùå slot.tsx dependency not resolved" && exit 1)
          echo "‚úÖ Complex dependency resolution working correctly"

      - name: Test CLI with BUN - Test guide command
        if: matrix.package-manager == 'bun'
        run: |
          cd test-bun-project
          bunx leshi-ui guide components | grep -q "button" || (echo "‚ùå Guide command not working" && exit 1)
          echo "‚úÖ Guide command working correctly"

      # Test Unistyles variant
      - name: Test Unistyles init
        run: |
          mkdir -p test-unistyles-project
          cd test-unistyles-project
          echo '{"name": "test-unistyles", "version": "1.0.0", "dependencies": {"react-native": "^0.70.0"}}' > package.json
          echo 'module.exports = {};' > metro.config.js
          mkdir -p android ios
          if [ "${{ matrix.package-manager }}" = "npm" ]; then
            npm install ../cli/leshi-ui-*.tgz
            npx leshi-ui init unistyles --yes
          else
            bun install ../cli/leshi-ui-*.tgz
            bunx leshi-ui init unistyles --yes
          fi

      - name: Verify Unistyles configuration
        run: |
          cd test-unistyles-project
          test -f leshi-ui.json || (echo "‚ùå leshi-ui.json not created" && exit 1)
          grep -q "unistyles" leshi-ui.json || (echo "‚ùå Unistyles config not found" && exit 1)
          echo "‚úÖ Unistyles variant working correctly"

      # Test CLI package content
      - name: Verify CLI package contains required files
        run: |
          cd cli
          tar -tzf leshi-ui-*.tgz | grep -q "dist/index.js" || (echo "‚ùå dist/index.js not in package" && exit 1)
          tar -tzf leshi-ui-*.tgz | grep -q "packages/" || (echo "‚ùå packages/ not in package" && exit 1)
          tar -tzf leshi-ui-*.tgz | grep -q "package.json" || (echo "‚ùå package.json not in package" && exit 1)
          echo "‚úÖ CLI package contains all required files"

      # Summary
      - name: Test Summary
        run: |
          echo "üéâ ALL CLI TESTS PASSED FOR ${{ matrix.package-manager }}!"
          echo "‚úÖ TypeScript compilation"
          echo "‚úÖ Unit tests"
          echo "‚úÖ CLI package creation"
          echo "‚úÖ Init command (${{ matrix.package-manager }})"
          echo "‚úÖ Theme files creation"
          echo "‚úÖ Simple component addition"
          echo "‚úÖ Dependency resolution"
          echo "‚úÖ Complex dependency resolution"
          echo "‚úÖ Guide commands"
          echo "‚úÖ Unistyles variant"
          echo "‚úÖ Package integrity"

  # Test CLI in different environments
  test-cli-environments:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18, 20]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install CLI dependencies
        run: |
          cd cli
          npm install

      - name: Build CLI
        run: |
          cd cli
          npm run build

      - name: Test CLI help command
        run: |
          cd cli
          node dist/index.js --help

      - name: Test CLI version command
        run: |
          cd cli
          node dist/index.js --version

      - name: Verify CLI executable
        shell: bash
        run: |
          cd cli
          chmod +x dist/index.js
          ./dist/index.js --help | grep -q "leshi-ui" || (echo "‚ùå CLI not executable" && exit 1)
          echo "‚úÖ CLI executable works on ${{ matrix.os }} with Node ${{ matrix.node-version }}"

  # Test that import transformer is working properly
  test-import-transformer:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install CLI dependencies
        run: |
          cd cli
          npm install

      - name: Test import transformer unit tests
        run: |
          cd cli
          npm test -- --testNamePattern="ImportTransformer"

      - name: Build CLI
        run: |
          cd cli
          npm run build

      # Note: Import transformer is currently disabled for testing
      # This test ensures it can be re-enabled when needed
      - name: Verify import transformer can be enabled
        run: |
          cd cli/src/commands
          grep -q "transformImports" add.ts || (echo "‚ùå Import transformer not found" && exit 1)
          echo "‚úÖ Import transformer code is present and can be re-enabled"
